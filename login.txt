import streamlit as st
import sys
import os
from PIL import Image
from auth_login.database import AuthenticationManager


class LoginManager:
    """Handles authentication logic"""
    
    def __init__(self):
        self.auth = AuthenticationManager()
    
    def authenticate(self, username: str, password: str) -> tuple[bool, str, dict | None]:
        """Authenticate user with username and password"""
        try:
            user = self.auth.authenticate_user(username, password)
            self.auth.close_pool()
            
            if user:
                return True, "Login successful!", user
            else:
                return False, "Invalid username or password", None
        except Exception as e:
            return False, f"Error: {str(e)}", None
    
    def set_session_state(self, user: dict):
        """Set user session state"""
        st.session_state.logged_in = True
        st.session_state.user = user
        st.session_state.user_id = user['id']


class LoginPage:
    """Handles login page UI and rendering"""
    
    CSS_STYLES = """
    <style>   
    * {
        margin: 0;
        padding: 0;
    }
                
    .button-wrapper button {
        margin-top: -10px !important;
    }

    html, body, [data-testid="stAppViewContainer"] {
        background: #0f0f1e;
    }

    [data-testid="stMainBlockContainer"] {
        padding: 0 !important;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
    }

    /* Page padding */
    [data-testid="stAppViewContainer"] {
        padding-left: 10px !important;
        padding-right: 10px !important;
    }

    /* Reduce width of text input boxes */
    .small-input input {
        width: 200px !important;
        height: 40px !important;
        padding: 8px 12px !important;
        font-size: 16px !important;
        border-radius: 8px !important;
    }

    /* Alternative: Target Streamlit input container */
    .small-input [data-testid="stTextInput"] {
        max-width: 200px !important;
    }

    .small-input .stTextInput > div > div > input {
        width: 200px !important;
        max-width: 200px !important;
    }

    /* Reduce width of buttons */
    .small-button button {
        width: 350px !important;
        height: 40px !important;
        font-size: 15px !important;
        border-radius: 8px !important;
    }

    /* Image styling */
    .image-box img {
        width: 85%;
        max-width: 330px;
        border-radius: 12px;
    }

    .login-title {
        color: #fff;
        font-size: 3.5em;
        font-weight: 700;
        font-family: 'Arial', 'Helvetica', sans-serif;
        margin-bottom: 15px;
        margin-top: -10px;
    }

    .login-label {
        color: #ccc;
        font-size: 0.9em;
        margin-bottom: 5px;
        margin-top: 10px;
    }

    .page-container {
        margin-left: 100px;
    }
    </style>
    """
    
    def __init__(self, image_path: str = None):
        """Initialize login page with optional custom image path"""
        self.image_path = image_path or os.path.join(
            os.path.dirname(__file__), 
            '..', 
            'auth_login', 
            'image.png'
        )
        self.login_manager = LoginManager()
        self._init_session_state()
        self._apply_styles()
    
    def _init_session_state(self):
        """Initialize session state"""
        if 'logged_in' not in st.session_state:
            st.session_state.logged_in = False
            st.session_state.user = None
            st.session_state.user_id = None
    
    def _apply_styles(self):
        """Apply custom CSS styles"""
        st.markdown(self.CSS_STYLES, unsafe_allow_html=True)
    
    def _load_image(self) -> Image.Image | None:
        """Load the login page image"""
        if os.path.exists(self.image_path):
            try:
                return Image.open(self.image_path)
            except Exception as e:
                st.error(f"Error loading image: {e}")
                return None
        else:
            st.warning(f"Image not found at: {self.image_path}")
            return None
    
    def _render_login_form(self) -> tuple[str, str, bool]:
        """Render login form and return username, password, and login button state"""
        # Username field
        username_col, _ = st.columns([0.6, 0.5])
        with username_col:
            username = st.text_input("Username", placeholder="Enter your username", label_visibility="collapsed")
    
        # Password field
        password_col, _ = st.columns([0.6, 0.5])
        with password_col:
            password = st.text_input("Password", type="password", placeholder="Enter your password", label_visibility="collapsed")
            st.markdown('</div>', unsafe_allow_html=True)
    
        # Login button
        st.markdown('<div class="button-wrapper">', unsafe_allow_html=True)
        login_clicked = st.button("Login")
        st.markdown('<div style="height:-20px;"></div>', unsafe_allow_html=True)
        st.button("Continue as Guest", disabled=True)
        st.markdown('</div>', unsafe_allow_html=True)
        
        return username, password, login_clicked
    
    def render(self):
        """Render the complete login page"""
        st.set_page_config(
            page_title="Asset Management Login",
            page_icon="üîê",
            layout="wide",
            initial_sidebar_state="collapsed"
        )
        
        # Center title at top
        st.markdown('<div class="login-title" style="text-align: center;">Valve 360</div>', unsafe_allow_html=True)

        # Layout with image and form
        spacer, col1, col2 = st.columns([0.43, 0.75, 1], gap="large")

        # LEFT (IMAGE)
        with col1:
            img = self._load_image()
            if img:
                st.markdown('<div class="image-box">', unsafe_allow_html=True)
                st.image(img, use_container_width=False)
                st.markdown('</div>', unsafe_allow_html=True)

        # RIGHT (FORM)
        with col2:
            st.markdown('<div style="margin-top: 50px;"></div>', unsafe_allow_html=True)
            username, password, login_clicked = self._render_login_form()
            msg = st.empty()

            if login_clicked:
                if not username or not password:
                    msg.error("Please enter both username and password")
                else:
                    with st.spinner("Logging in..."):
                        success, message, user = self.login_manager.authenticate(username, password)
                        if success:
                            self.login_manager.set_session_state(user)
                            msg.success(message)
                            st.balloons()
                            st.rerun()
                        else:
                            msg.error(message)
    
    def show_dashboard_message(self):
        """Show message when user is logged in"""
        st.success(f"Logged in as {st.session_state.user['username']}. Dashboard coming soon...")


class LoginApp:
    """Main application class"""
    
    def __init__(self, image_path: str = None):
        """Initialize the login app"""
        self.login_page = LoginPage(image_path)
    
    def run(self):
        """Run the login app"""
        if st.session_state.logged_in:
            self.login_page.show_dashboard_message()
        else:
            self.login_page.render()


# ==================== MAIN ENTRY POINT ====================

if __name__ == "__main__":
    app = LoginApp()
    app.run()
